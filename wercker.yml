box:
    id: $DOCKER_REGISTRY/$IMAGE_NAME
    tag: $APP_TAG
    registry: https://registry.hub.docker.com

build:
  steps:
    - script:
        name: install packages
        code: |
            yum -y install unzip iptables postgresql util-linux iputils sudo net-tools
            curl -O $GLASSFISH_URL
            echo "$GLASSFISH_MD5 *$GLASSFISH_PKG" | md5sum -c
            unzip -o $GLASSFISH_PKG -d /
            rm -f $GLASSFISH_PKG
            yum clean all
            export PATH=$PATH:/glassfish4/bin

    - script:
        name: copy files
        code: |
              ln -s ./docker-entrypoint.sh /docker-entrypoint.sh
              ln -s ./start-domain.sh /start-domain.sh
              ln -s ./setupDB-postgres.sh /setupDB-postgres.sh
              cp ./lib/org.eclipse.persistence.moxy.jar $GLASSFISH_HOME/glassfish/modules
              ln -s ./lib /projectLib
    - script:
        name: check
        code: |
            pwd
            ls -l
            ls -l /
            env
            echo $PATH
deploy:
  steps:
    - internal/docker-push:
        username: $DOCKER_USERNAME
        password: $DOCKER_PASSWORD
        #tag: $WERCKER_MAIN_PIPELINE_STARTED
        tag: wercker
        repository: $DOCKER_REGISTRY/$APP_NAME
        registry: https://registry.hub.docker.com
